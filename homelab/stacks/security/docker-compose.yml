services:
  wazuh-indexer:
    image: wazuh/wazuh-indexer:4.13.1
    platform: linux/amd64
    hostname: wazuh-indexer
    restart: always
    ports:
      - "9200:9200"
    environment:
      - "OPENSEARCH_JAVA_OPTS=-Xms2g -Xmx2g"
      - "OPENSEARCH_INITIAL_ADMIN_PASSWORD=${INDEXER_PASSWORD}"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - wazuh-indexer-data:/var/lib/wazuh-indexer
      - ./certs:/usr/share/wazuh-indexer/certs:ro
    configs:
      - source: indexer_config
        target: /usr/share/wazuh-indexer/opensearch.yml
    healthcheck:
      test: ["CMD-SHELL", "curl -XGET https://localhost:9200 -u admin:${INDEXER_PASSWORD} -k >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  wazuh-manager:
    image: wazuh/wazuh-manager:4.13.1
    platform: linux/amd64
    hostname: wazuh-manager
    restart: always
    depends_on:
      wazuh-indexer:
        condition: service_healthy
    ports:
      - "1514:1514/udp"  # Agent events
      - "1515:1515"      # Agent enrollment
      - "514:514/udp"    # Syslog collector (optional)
      - "55000:55000"    # API
    environment:
      - INDEXER_URL=https://wazuh-indexer:9200
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=${INDEXER_PASSWORD}
      - FILEBEAT_SSL_VERIFICATION_MODE=none
      - SSL_CERTIFICATE_AUTHORITIES=/etc/ssl/certs/root-ca.pem
      - API_USERNAME=wazuh-wui
      - API_PASSWORD=${API_PASSWORD}
    volumes:
      - wazuh-manager-config:/var/ossec/etc
      - wazuh-manager-logs:/var/ossec/logs
      - wazuh-manager-data:/var/ossec/data
      - ./certs:/etc/ssl/certs:ro
    healthcheck:
      test: ["CMD-SHELL", "/var/ossec/bin/wazuh-control status | grep -q 'wazuh-modulesd is running' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  wazuh-dashboard:
    image: wazuh/wazuh-dashboard:4.13.1
    platform: linux/amd64
    hostname: wazuh-dashboard
    restart: always
    depends_on:
      wazuh-indexer:
        condition: service_healthy
      wazuh-manager:
        condition: service_healthy
    ports:
      - "5601:5601"
    environment:
      - OPENSEARCH_HOSTS=https://wazuh-indexer:9200
      - DASHBOARD_USERNAME=admin
      - DASHBOARD_PASSWORD=${INDEXER_PASSWORD}
      - WAZUH_API_URL=https://wazuh-manager
      - API_USERNAME=wazuh-wui
      - API_PASSWORD=${API_PASSWORD}
    volumes:
      - ./certs:/usr/share/wazuh-dashboard/certs:ro
    configs:
      - source: dashboard_config
        target: /usr/share/wazuh-dashboard/config/opensearch_dashboards.yml
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:5601/api/status 2>&1 | grep -q '\"state\":\"green\"' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s

volumes:
  wazuh-indexer-data:
    driver: local
  wazuh-manager-config:
    driver: local
  wazuh-manager-logs:
    driver: local
  wazuh-manager-data:
    driver: local

networks:
  default:
    driver: bridge

configs:
  indexer_config:
    content: |
      cluster.name: wazuh
      node.name: wazuh-indexer
      network.host: 0.0.0.0
      http.port: 9200
      discovery.type: single-node
      bootstrap.memory_lock: true

      # Enable security plugin
      plugins.security.ssl.transport.pemcert_filepath: /usr/share/wazuh-indexer/certs/indexer.pem
      plugins.security.ssl.transport.pemkey_filepath: /usr/share/wazuh-indexer/certs/indexer-key.pem
      plugins.security.ssl.transport.pemtrustedcas_filepath: /usr/share/wazuh-indexer/certs/root-ca.pem
      plugins.security.ssl.transport.enforce_hostname_verification: false

      plugins.security.ssl.http.enabled: true
      plugins.security.ssl.http.pemcert_filepath: /usr/share/wazuh-indexer/certs/indexer.pem
      plugins.security.ssl.http.pemkey_filepath: /usr/share/wazuh-indexer/certs/indexer-key.pem
      plugins.security.ssl.http.pemtrustedcas_filepath: /usr/share/wazuh-indexer/certs/root-ca.pem

      plugins.security.allow_unsafe_democertificates: true
      plugins.security.allow_default_init_securityindex: true
      plugins.security.authcz.admin_dn:
        - "CN=admin,O=Wazuh,L=SF,ST=CA,C=US"

      plugins.security.audit.type: internal_opensearch
      plugins.security.enable_snapshot_restore_privilege: true
      plugins.security.check_snapshot_restore_write_privileges: true
      plugins.security.restapi.roles_enabled: ["all_access", "security_rest_api_access"]

  dashboard_config:
    content: |
      server.host: "0.0.0.0"
      server.port: 5601

      # OpenSearch connection
      opensearch.hosts: ["https://wazuh-indexer:9200"]
      opensearch.ssl.verificationMode: none
      opensearch.requestHeadersAllowlist: ["securitytenant","Authorization"]

      # Logging
      logging.dest: stdout
      logging.quiet: false
